<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="《30天自制操作系统》"><meta name="keywords" content="操作系统,C"><meta name="author" content="原田莓莓,undefined"><meta name="copyright" content="原田莓莓"><title>《30天自制操作系统》 | 原田莓莓</title><link rel="shortcut icon" href="/favicon.ico"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.min.css?version=1.5.2"><script>var GLOBAL = { 
  root: '/',
  algolia: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  localSearch: undefined
} </script><meta name="generator" content="Hexo 5.3.0"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="文章详情">站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC1%E5%A4%A9-4%E6%9C%8820%E6%97%A5"><span class="toc-number">1.</span> <span class="toc-text">第1天 4月20日</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC2%E5%A4%A9-4%E6%9C%8821%E6%97%A5"><span class="toc-number">2.</span> <span class="toc-text">第2天 4月21日</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC3%E5%A4%A9-4%E6%9C%8822%E6%97%A5"><span class="toc-number">3.</span> <span class="toc-text">第3天 4月22日</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC4%E5%A4%A9-4%E6%9C%8823%E6%97%A5"><span class="toc-number">4.</span> <span class="toc-text">第4天 4月23日</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC5%E5%A4%A9-4%E6%9C%8824%E6%97%A5"><span class="toc-number">5.</span> <span class="toc-text">第5天 4月24日</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC6%E5%A4%A9-4%E6%9C%8824%E6%97%A5"><span class="toc-number">6.</span> <span class="toc-text">第6天 4月24日</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC7%E5%A4%A9-4%E6%9C%8825%E6%97%A5"><span class="toc-number">7.</span> <span class="toc-text">第7天 4月25日</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC8%E5%A4%A9-4%E6%9C%8825%E6%97%A5"><span class="toc-number">8.</span> <span class="toc-text">第8天 4月25日</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC9%E5%A4%A9-4%E6%9C%8826%E6%97%A5"><span class="toc-number">9.</span> <span class="toc-text">第9天 4月26日</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC10%E5%A4%A9-4%E6%9C%8826%E6%97%A5"><span class="toc-number">10.</span> <span class="toc-text">第10天 4月26日</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC11%E5%A4%A9-4%E6%9C%8826%E6%97%A5"><span class="toc-number">11.</span> <span class="toc-text">第11天 4月26日</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC12%E5%A4%A9-4%E6%9C%8827%E6%97%A5"><span class="toc-number">12.</span> <span class="toc-text">第12天 4月27日</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC13%E5%A4%A9-4%E6%9C%8828%E6%97%A5"><span class="toc-number">13.</span> <span class="toc-text">第13天 4月28日</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC14%E5%A4%A9-4%E6%9C%8828%E6%97%A5"><span class="toc-number">14.</span> <span class="toc-text">第14天 4月28日</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC15%E5%A4%A9-4%E6%9C%8829%E6%97%A5"><span class="toc-number">15.</span> <span class="toc-text">第15天 4月29日</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC16%E5%A4%A9-4%E6%9C%8830%E6%97%A5"><span class="toc-number">16.</span> <span class="toc-text">第16天 4月30日</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC17%E5%A4%A9-5%E6%9C%881%E6%97%A5"><span class="toc-number">17.</span> <span class="toc-text">第17天 5月1日</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC18%E5%A4%A9-5%E6%9C%881%E6%97%A5"><span class="toc-number">18.</span> <span class="toc-text">第18天 5月1日</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC19%E5%A4%A9-5%E6%9C%882%E6%97%A5"><span class="toc-number">19.</span> <span class="toc-text">第19天 5月2日</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC20%E5%A4%A9-5%E6%9C%883%E6%97%A5"><span class="toc-number">20.</span> <span class="toc-text">第20天 5月3日</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC21%E5%A4%A9-5%E6%9C%886%E6%97%A5"><span class="toc-number">21.</span> <span class="toc-text">第21天 5月6日</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC22%E5%A4%A9-5%E6%9C%887%E6%97%A5"><span class="toc-number">22.</span> <span class="toc-text">第22天 5月7日</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC23%E5%A4%A9-5%E6%9C%8810%E6%97%A5"><span class="toc-number">23.</span> <span class="toc-text">第23天 5月10日</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC24%E5%A4%A9-5%E6%9C%8813%E6%97%A5"><span class="toc-number">24.</span> <span class="toc-text">第24天 5月13日</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC25%E5%A4%A9-5%E6%9C%8814%E6%97%A5"><span class="toc-number">25.</span> <span class="toc-text">第25天 5月14日</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC26%E5%A4%A9-5%E6%9C%8816%E6%97%A5-5%E6%9C%8819%E6%97%A5"><span class="toc-number">26.</span> <span class="toc-text">第26天 5月16日~5月19日</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC27%E5%A4%A9-5%E6%9C%8823%E6%97%A5"><span class="toc-number">27.</span> <span class="toc-text">第27天 5月23日</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC28%E5%A4%A9-5%E6%9C%8824%E6%97%A5"><span class="toc-number">28.</span> <span class="toc-text">第28天 5月24日</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/favicon.ico"></div><div class="author-info__name text-center">原田莓莓</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">73</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">34</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">10</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">友情链接</div><a class="author-info-links__name text-center" href="https://www.byvoid.com" target="_blank">BYVoid</a><a class="author-info-links__name text-center" href="https://zr.is/" target="_blank">Zeyi Fan</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(/images/background/shinohayu1920.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">原田莓莓</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">首页</a><a class="site-page" href="/archives">博文</a><a class="site-page" href="/tags">标签</a><a class="site-page" href="/categories">分类</a><a class="site-page" href="/about">关于</a></span></div><div id="post-info"><div id="post-title">《30天自制操作系统》</div><div id="post-etitle">30日でできる！OS自作入門</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2015-04-20</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E8%AE%80%E6%9B%B8%E7%AD%86%E8%A8%98/">讀書筆記</a><span class="post-meta__separator">|</span><i class="fa fa-comment-o post-meta__icon" aria-hidden="true"></i><a href="/osask/#disqus_thread"><span class="disqus-comment-count" data-disqus-identifier="osask/"></span></a></div></div></div><div class="layout" id="content-inner"><article id="post"><div id="post-content"><p>书上讲得很细了，我就说说我在制作过程中和书中不一样的做法。</p>
<h3 id="第1天-4月20日"><a href="#第1天-4月20日" class="headerlink" title="第1天 4月20日"></a>第1天 4月20日</h3><p>写机器码，用的是书中的<a target="_blank" rel="noopener" href="http://www.vcraft.jp/soft/bz.html">Bz编辑器</a>，还是蛮好用的。</p>
<p>写汇编，因为有了<a href="/cs-app/">CS:APP</a>的基础，对于这个自定义的NASK汇编也能很快理解。</p>
<h3 id="第2天-4月21日"><a href="#第2天-4月21日" class="headerlink" title="第2天 4月21日"></a>第2天 4月21日</h3><p>做启动程序，写了个Makefile。</p>
<h3 id="第3天-4月22日"><a href="#第3天-4月22日" class="headerlink" title="第3天 4月22日"></a>第3天 4月22日</h3><p>把程序分离开做IPL。读入前几个柱面之后进入32位模式，就可以使用C语言了。这个启动信息的结构体我定义了一个<code>bootinfo_t</code>类型来简写，而且以后的结构体都这样简写。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">BOOTINFO</span> &#123;</span></span><br><span class="line">    <span class="keyword">char</span> cyls, leds, vmode, reserve;</span><br><span class="line">    <span class="keyword">short</span> scrnx, scrny;</span><br><span class="line">    <span class="keyword">char</span> *vram;</span><br><span class="line">&#125; <span class="keyword">bootinfo_t</span>;</span><br></pre></td></tr></table></figure>
<h3 id="第4天-4月23日"><a href="#第4天-4月23日" class="headerlink" title="第4天 4月23日"></a>第4天 4月23日</h3><p>加载到图形模式就变得有意思了，首先是颜色，书中给出的16色实在不好看，我就用了编程中常用的<a target="_blank" rel="noopener" href="http://ethanschoonover.com/solarized">Solarized配色方案</a>。到画任务栏的时候，我采取了现在比较流行的扁平化界面。为了画Windows徽标，我又将红黄蓝绿这四个颜色做了微调，于是我们就能看到这个漂亮的四色视窗图标了。另外，黑白两色复原。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> base03   0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> base02   1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> base01   2</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> base00   3</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> base0    4</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> base1    5</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> base2    6</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> base3    7</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> yellow   8</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> orange   9</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> red     10</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> magenta 11</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> violet  12</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> blue    13</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> cyan    14</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> green   15</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> table_rgb[<span class="number">16</span> * <span class="number">3</span>] = &#123;</span><br><span class="line">    <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="comment">/* base03 */</span></span><br><span class="line">    <span class="number">0x07</span>, <span class="number">0x36</span>, <span class="number">0x42</span>, <span class="comment">/* base02 */</span></span><br><span class="line">    <span class="number">0x58</span>, <span class="number">0x6e</span>, <span class="number">0x75</span>, <span class="comment">/* base01 */</span></span><br><span class="line">    <span class="number">0x65</span>, <span class="number">0x7b</span>, <span class="number">0x83</span>, <span class="comment">/* base00 */</span></span><br><span class="line">    <span class="number">0x83</span>, <span class="number">0x94</span>, <span class="number">0x96</span>, <span class="comment">/* base0 */</span></span><br><span class="line">    <span class="number">0x93</span>, <span class="number">0xa1</span>, <span class="number">0xa1</span>, <span class="comment">/* base1 */</span></span><br><span class="line">    <span class="number">0xee</span>, <span class="number">0xe8</span>, <span class="number">0xd5</span>, <span class="comment">/* base2 */</span></span><br><span class="line">    <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="number">0xff</span>, <span class="comment">/* base3 */</span></span><br><span class="line">    <span class="number">0xfd</span>, <span class="number">0xb8</span>, <span class="number">0x13</span>, <span class="comment">/* yellow */</span></span><br><span class="line">    <span class="number">0xcb</span>, <span class="number">0x4b</span>, <span class="number">0x16</span>, <span class="comment">/* orange */</span></span><br><span class="line">    <span class="number">0xef</span>, <span class="number">0x50</span>, <span class="number">0x26</span>, <span class="comment">/* red */</span></span><br><span class="line">    <span class="number">0xd3</span>, <span class="number">0x36</span>, <span class="number">0x82</span>, <span class="comment">/* magenta */</span></span><br><span class="line">    <span class="number">0x6c</span>, <span class="number">0x71</span>, <span class="number">0xc4</span>, <span class="comment">/* violet */</span></span><br><span class="line">    <span class="number">0x23</span>, <span class="number">0x99</span>, <span class="number">0xd7</span>, <span class="comment">/* blue */</span></span><br><span class="line">    <span class="number">0x2a</span>, <span class="number">0xa1</span>, <span class="number">0x98</span>, <span class="comment">/* cyan */</span></span><br><span class="line">    <span class="number">0x7f</span>, <span class="number">0xbc</span>, <span class="number">0x43</span>, <span class="comment">/* green */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><img src="/images/osask/day04_taskbar.png" alt="任务栏"></p>
<h3 id="第5天-4月24日"><a href="#第5天-4月24日" class="headerlink" title="第5天 4月24日"></a>第5天 4月24日</h3><p>今天更有意思了，在屏幕上显示鼠标指针和字体。一直以来都觉得书里面给出的指针太难看，就仔细分析了一下Windows 8的鼠标指针形状，将其描绘了出来。注意到这个鼠标指针是19×12大小的，要做相应修改。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CURSOR_X     12</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CURSOR_Y     19</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> cursor[CURSOR_Y][CURSOR_X] = &#123;</span><br><span class="line">    <span class="string">&quot;*           &quot;</span>,</span><br><span class="line">    <span class="string">&quot;**          &quot;</span>,</span><br><span class="line">    <span class="string">&quot;*O*         &quot;</span>,</span><br><span class="line">    <span class="string">&quot;*OO*        &quot;</span>,</span><br><span class="line">    <span class="string">&quot;*OOO*       &quot;</span>,</span><br><span class="line">    <span class="string">&quot;*OOOO*      &quot;</span>,</span><br><span class="line">    <span class="string">&quot;*OOOOO*     &quot;</span>,</span><br><span class="line">    <span class="string">&quot;*OOOOOO*    &quot;</span>,</span><br><span class="line">    <span class="string">&quot;*OOOOOOO*   &quot;</span>,</span><br><span class="line">    <span class="string">&quot;*OOOOOOOO*  &quot;</span>,</span><br><span class="line">    <span class="string">&quot;*OOOOOOOOO* &quot;</span>,</span><br><span class="line">    <span class="string">&quot;*OOOOOOOOOO*&quot;</span>,</span><br><span class="line">    <span class="string">&quot;*OOOOOO*****&quot;</span>,</span><br><span class="line">    <span class="string">&quot;*OOO*OO*    &quot;</span>,</span><br><span class="line">    <span class="string">&quot;*OO* *OO*   &quot;</span>,</span><br><span class="line">    <span class="string">&quot;*O*  *OO*   &quot;</span>,</span><br><span class="line">    <span class="string">&quot;**    *OO*  &quot;</span>,</span><br><span class="line">    <span class="string">&quot;      *OO*  &quot;</span>,</span><br><span class="line">    <span class="string">&quot;       **   &quot;</span></span><br><span class="line">&#125;; <span class="comment">/* 仿 Window 8 的鼠标指针 */</span></span><br></pre></td></tr></table></figure>
<p>这个鼠标指针我觉得还是蛮好看的，虽然在虚拟机里放大了有很明显的锯齿。</p>
<p>关于字体，先开始我直接用了书中给出的字体，这个字体又大又丑（16px），虽然因为懒不想动了但实在是忍不住，上网找个了好看点的点阵字体：<a target="_blank" rel="noopener" href="https://code.google.com/p/zpix">最像素EX2</a>（12px）。这个字体不仅好看，而且包含中日字符，虽然暂时用不到，但是有了一劳永逸的感觉。用FontForge打开这个字体，另外生成一个基于ASCII编码表的Windows FNT字体。算一下，一个字符12px，每行用一个字节表述，就是12字节；一共256个字符，就是256×12=3456字节。可是看了看这个<code>ZpixEX2-12.fnt</code>文件是3529字节，多出了73字节，直接载入运行的话果然乱码了。用Bz打开看看，发现头部有一些字体描述信息，所以我尝试找这个偏移量。经过多次试错和计算，终于算出来这个偏移量是45×16=726字符（这里还有问题，在45(0x2D)处实际上是<code>de.google.com/p/zpix</code>这个字符串，剩下的二进制数据意义不明。已知用FontForge打开这个文件可以看到在0x20之前没有数据。另外，0x7f-0x9f也没有字形数据，后面的估计也会出错。不过这里我们只用到0x20-0x7e之间的普通字符，暂时还好。），定义成常量。另外也要注意，因为这里变成了12px的字体，所以相应的行高和字宽都要做更改，同样定义成常量。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FNT_H        12</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FNT_W         6  <span class="comment">// FNT_H / 2</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FNT_OFFSET  726  <span class="comment">// 65 + 55 * FNT_H + 1</span></span></span><br></pre></td></tr></table></figure>
<p>效果还不错，左边的是书中的Haribote-OS ，右边的是我们的。既然看起来还不错，我给它起个名字叫霹雳啪啦操作系统吧（笑）。</p>
<p><img src="/images/osask/day05_1osask.png" alt="书中的例子">
<img src="/images/osask/day05_2font.png" alt="指针和字体"></p>
<h3 id="第6天-4月24日"><a href="#第6天-4月24日" class="headerlink" title="第6天 4月24日"></a>第6天 4月24日</h3><p>鼠标不能动，很不爽，于是强行往下做了一天。我们用C语言混着汇编，定义了三个中断的捕获函数。不过只捕获到了键盘中断，鼠标还是没反应。</p>
<p><img src="/images/osask/day06_int21.png" alt="键盘中断"></p>
<h3 id="第7天-4月25日"><a href="#第7天-4月25日" class="headerlink" title="第7天 4月25日"></a>第7天 4月25日</h3><p>使用一个FIFO队列缓冲区来获取按键编码，然后我们就可以获取3字节的鼠标数据了。</p>
<h3 id="第8天-4月25日"><a href="#第8天-4月25日" class="headerlink" title="第8天 4月25日"></a>第8天 4月25日</h3><p>获取鼠标数据后，解析出来移动位置，就可以在屏幕上移动鼠标了。鼠标能动了当然是很高兴，不过明显这个移动逻辑太单纯，以至于把我们可爱的任务栏都擦除了。</p>
<p><img src="/images/osask/day08_pointer1.png" alt="鼠标移动">
<img src="/images/osask/day08_pointer2.png" alt="鼠标移动"></p>
<p>然后终于把汇编部分讲明白了。</p>
<h3 id="第9天-4月26日"><a href="#第9天-4月26日" class="headerlink" title="第9天 4月26日"></a>第9天 4月26日</h3><p>检查内存容量，在此基础上实现了一个简单的内存管理，通过管理空闲内存块来分配和释放内存。</p>
<h3 id="第10天-4月26日"><a href="#第10天-4月26日" class="headerlink" title="第10天 4月26日"></a>第10天 4月26日</h3><p>实现了图层，这样我们的鼠标就可以穿过任务栏而不至于破坏它了。一个小的改动，把<code>sheet_t</code>结构体的透明色标识符改成了<code>alpha</code>。</p>
<p><img src="/images/osask/day10_sheet.png" alt="图层"></p>
<h3 id="第11天-4月26日"><a href="#第11天-4月26日" class="headerlink" title="第11天 4月26日"></a>第11天 4月26日</h3><p>绘制了一个窗口，刚开始我想弄成Windows 8那样的，不过我发现它的边框太大了，就做了一些修改。同样的，关闭按钮也不合适，改。还有窗口标题要居中。嗯，看看这个计数器窗口，是不是有点像Windows 10了。</p>
<p><img src="/images/osask/day11_window1.png" alt="窗口">
<img src="/images/osask/day11_window2.png" alt="计数器窗口"></p>
<p>这里的“PriPara = Prism Paradise”刚从桌面上了窗口就要说拜拜了，プリパラ=プリティーリズムパラダイス，这就是霹雳啪啦的意思咯。</p>
<h3 id="第12天-4月27日"><a href="#第12天-4月27日" class="headerlink" title="第12天 4月27日"></a>第12天 4月27日</h3><p>设置多个定时器，计量时间等。主要优化了中断的处理。</p>
<h3 id="第13天-4月28日"><a href="#第13天-4月28日" class="headerlink" title="第13天 4月28日"></a>第13天 4月28日</h3><p>继续优化定时器，将队列缓冲区扩展到32位，用链表来加快中断处理。</p>
<h3 id="第14天-4月28日"><a href="#第14天-4月28日" class="headerlink" title="第14天 4月28日"></a>第14天 4月28日</h3><p>我们又在图形界面上取得了重大进展，这是最令人振奋的。首先使用了VBE提高了屏幕分辨率。然后我们捕获了键盘输入，显示在屏幕上，还画了个漂亮的文本框和光标（当然还是仿Windows 8的）。最后，窗口也能移动了，真是太开心了。</p>
<p><img src="/images/osask/day14_type.png" alt="大分辨率"></p>
<h3 id="第15天-4月29日"><a href="#第15天-4月29日" class="headerlink" title="第15天 4月29日"></a>第15天 4月29日</h3><p>今天我们加入了多任务，就是时间片分割，保存上下文。</p>
<p>测试速度：QEMU约是4百万，VirtualBox约是4千万。</p>
<h3 id="第16天-4月30日"><a href="#第16天-4月30日" class="headerlink" title="第16天 4月30日"></a>第16天 4月30日</h3><p>实现了任务管理自动化、任务休眠，并且设定了任务优先级和优先层。</p>
<p>测试速度：QEMU约是8百万，VirtualBox约是7千万。提高了一倍。</p>
<p><img src="/images/osask/day16_mtask.png" alt="大分辨率"></p>
<h3 id="第17天-5月1日"><a href="#第17天-5月1日" class="headerlink" title="第17天 5月1日"></a>第17天 5月1日</h3><p>创建了命令行窗口，实现了字符输入，包括大小写字母和符号、锁定键。</p>
<p><img src="/images/osask/day17_terminal.png" alt="大分辨率"></p>
<h3 id="第18天-5月1日"><a href="#第18天-5月1日" class="headerlink" title="第18天 5月1日"></a>第18天 5月1日</h3><p>修正了光标闪烁，实现了回车换行和滚屏。</p>
<p>实现了显示内存大小的<code>mem</code>，显示目录内容的<code>dir</code>命令（别名<code>ls -l</code>）、清屏的<code>cls</code>命令（别名<code>clear</code>）。</p>
<h3 id="第19天-5月2日"><a href="#第19天-5月2日" class="headerlink" title="第19天 5月2日"></a>第19天 5月2日</h3><p>实现了显示文件内容的<code>type</code>（别名<code>cat</code>）命令，并支持FAT12文件系统。</p>
<p>这里我把命令行窗口改得更大了，便于显示更多内容。其实现使用了大量常量（改掉了原来的Magic Number）。</p>
<h3 id="第20天-5月3日"><a href="#第20天-5月3日" class="headerlink" title="第20天 5月3日"></a>第20天 5月3日</h3><p>开始编写应用程序，实现了显示字符和显示字符串的API。</p>
<p><img src="/images/osask/day21_terminal.png" alt="大分辨率"></p>
<h3 id="第21天-5月6日"><a href="#第21天-5月6日" class="headerlink" title="第21天 5月6日"></a>第21天 5月6日</h3><p>可以用C编写应用程序了。支持异常。</p>
<h3 id="第22天-5月7日"><a href="#第22天-5月7日" class="headerlink" title="第22天 5月7日"></a>第22天 5月7日</h3><p><code>Ctrl+C</code>强制结束任务。系统API的增加。</p>
<h3 id="第23天-5月10日"><a href="#第23天-5月10日" class="headerlink" title="第23天 5月10日"></a>第23天 5月10日</h3><p>malloc的实现。</p>
<p>显示窗口和关闭窗口。</p>
<h3 id="第24天-5月13日"><a href="#第24天-5月13日" class="headerlink" title="第24天 5月13日"></a>第24天 5月13日</h3><p>使用鼠标切换、移动和关闭窗口。</p>
<h3 id="第25天-5月14日"><a href="#第25天-5月14日" class="headerlink" title="第25天 5月14日"></a>第25天 5月14日</h3><p>256色。</p>
<h3 id="第26天-5月16日-5月19日"><a href="#第26天-5月16日-5月19日" class="headerlink" title="第26天 5月16日~5月19日"></a>第26天 5月16日~5月19日</h3><p>多任务内存分配和强制结束。</p>
<p>多个终端和关闭终端。</p>
<p><code>open</code>和<code>start</code>启动任务。</p>
<h3 id="第27天-5月23日"><a href="#第27天-5月23日" class="headerlink" title="第27天 5月23日"></a>第27天 5月23日</h3><p>整理目录结构。分拆API。使用局部段描述符保护程序。</p>
<h3 id="第28天-5月24日"><a href="#第28天-5月24日" class="headerlink" title="第28天 5月24日"></a>第28天 5月24日</h3><p>alloca的实现和局部大变量。</p>
<p>并不成功地汉字显示——至今没有解决和正在解决……目前是使用了Unifont的16点阵字体，编码使用UTF-8解析。</p>
</div></article><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">操作系统</a><a class="post-meta__tags" href="/tags/C/">C</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/ps-on-mac/"><i class="fa fa-chevron-left">  </i><span>Photoshop CC 2014 在 Mac 不能使用滤镜库的解决办法</span></a></div><div class="next-post pull-right"><a href="/talk-about-open-sourse-licenses/"><span>浅谈开源协议</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="disqus_thread"></div><script>var disqus_shortname = 'kingfree'
var disqus_config = function () {
  this.page.url = 'http://blog.kingfree.moe/osask/';
  this.page.identifier = 'osask/';
  this.page.title = '《30天自制操作系统》';
}
var d = document, s = d.createElement('script');
s.src = "https://" + disqus_shortname +".disqus.com/embed.js";
s.setAttribute('data-timestamp', '' + +new Date());
(d.head || d.body).appendChild(s);</script><script id="dsq-count-src" src="https://kingfree.disqus.com/count.js" async></script></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2008 - 2021 原田莓莓</div><div class="framework-info"><span>驱动 - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.5.2"></script><script src="/js/fancybox.js?version=1.5.2"></script><script src="/js/sidebar.js?version=1.5.2"></script><script src="/js/copy.js?version=1.5.2"></script><script src="/js/fireworks.js?version=1.5.2"></script><script src="/js/transition.js?version=1.5.2"></script><script src="/js/scroll.js?version=1.5.2"></script><script src="/js/head.js?version=1.5.2"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  }
});
</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
  var all = MathJax.Hub.getAllJax(), i;
  for (i=0; i < all.length; i += 1) {
    all[i].SourceElement().parentNode.className += ' has-jax';
  }
});
</script><script src="https://cdn.bootcss.com/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script></body></html>