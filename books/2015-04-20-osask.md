---
layout: page
title: 30天自制操作系统
tagline: 川合秀実
group: book
etitle: "30日でできる！OS自作入門"
permalink: /books/osask/
date: 2015-4-20
update: 2015-4-24
---

书上讲得很细了，我就说说我在制作过程中和书中不一样的做法。

## 第1天

写机器码，用的是书中的[Bz编辑器](http://www.vcraft.jp/soft/bz.html)，还是蛮好用的。

写汇编，因为有了[CS:APP](/books/cs-app/)的基础，对于这个自定义的NASK汇编也能很快理解。

## 第2天

做启动程序，写了个Makefile。

## 第3天

把程序分离开做IPL。读入前几个柱面之后进入32位模式，就可以使用C语言了。

## 第4天

加载到图形模式就变得有意思了，首先是颜色，书中给出的16色实在不好看，我就用了编程中常用的[Solarized配色方案](http://ethanschoonover.com/solarized)。到画任务栏的时候，为了画Windows徽标，我又将红黄蓝绿这四个颜色做了微调，于是我们就能看到这个漂亮的四色视窗图标了。

![任务栏](/images/osask/day04_taskbar.png)

## 第5天

今天更有意思了，在屏幕上显示鼠标指针和字体。一直以来都觉得这个指针太难看，就仔细分析了一下Windows 8的鼠标指针形状，将其描绘了出来。注意到这个鼠标指针是19×12大小的，要做相应修改。

    #define CURSOR_X 12
    #define CURSOR_Y 19

    static char cursor[CURSOR_Y][CURSOR_X] = {
        "*           ",
        "**          ",
        "*O*         ",
        "*OO*        ",
        "*OOO*       ",
        "*OOOO*      ",
        "*OOOOO*     ",
        "*OOOOOO*    ",
        "*OOOOOOO*   ",
        "*OOOOOOOO*  ",
        "*OOOOOOOOO* ",
        "*OOOOOOOOOO*",
        "*OOOOOO*****",
        "*OOO*OO*    ",
        "*OO* *OO*   ",
        "*O*  *OO*   ",
        "**    *OO*  ",
        "      *OO*  ",
        "       **   "
    }; /* 仿 Window 8 的鼠标指针 */

这个鼠标指针我觉得还是蛮好看的，。

![指针](/images/osask/day05_pointer.png)

关于字体，先开始我直接用了书中给出的字体，这个字体又大又丑（16px），虽然因为懒不想动了但实在是忍不住，上网找个了好看点的点阵字体：最像素EX2（12px）。这个字体不仅好看，而且包含中日字符，虽然暂时用不到，但是有了一劳永逸的感觉。用FontForge打开这个字体，另外生成一个基于ASCII编码表的Windows FNT字体。算一下，一个字符12px，每行用一个字节表述，就是12字节；一共256个字符，就是256×12=3456字节。可是看了看这个`ZpixEX2-12.fnt`文件是3529字节，多出了133字节，直接载入运行的话显然乱码了。用Bz打开看看，发现头部有一些字体描述信息，所以我尝试找这个偏移量。经过多次试错和计算，终于算出来这个偏移量是65 + 55 * FONT_H + 1 = 726字节，定义成常量。另外也要注意，因为这里变成了12px的字体，所以相应的行高和字宽都要做更改，同样定义成常量。

    #define FNT_H 12
    #define FNT_W 6 // FONT_H / 2
    #define FNT_OFFSET 726 // 65 + 55 * FONT_H + 1

效果还不错，就在托盘区加个系统版本吧！

![字体](/images/osask/day05_font.png)
